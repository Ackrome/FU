-- Создаем таблицу "Склады"
CREATE TABLE Склады (
    Номер SERIAL PRIMARY KEY,
    Адрес_склада VARCHAR(255) NOT NULL,
    Телефон VARCHAR(20),
    Фамилия_руководителя VARCHAR(100)
);

-- Создаем таблицу "Товары"
CREATE TABLE Товары (
    Код SERIAL PRIMARY KEY,
    Название VARCHAR(100) NOT NULL,
    Группа_товаров VARCHAR(100),
    Фирма_производитель VARCHAR(100)
);

-- Создаем таблицу "Наличие товаров"
CREATE TABLE Наличие_товаров (
    Номер_склада INTEGER,
    Код_товара INTEGER,
    Количество INTEGER NOT NULL,
    PRIMARY KEY (Номер_склада, Код_товара),
    FOREIGN KEY (Номер_склада) REFERENCES Склады(Номер) ON DELETE CASCADE,
    FOREIGN KEY (Код_товара) REFERENCES Товары(Код) ON DELETE CASCADE
);


INSERT INTO Склады (Номер, Адрес_склада, Телефон, Фамилия_руководителя) VALUES
(1, 'Первомайская, 1', '111111', 'Иванов'),
(2, 'Московское, 7', '222222', 'Сидоров'),
(3, 'Касимовское, 3', '111222', 'Петров'),
(4, 'Куйбышевское, 27', '334455', 'Ковалев'),
(5, 'Шабулина, 12', '121212', 'Маматов'),
(6, 'Яблочкова, 11', '345678', 'Маматов'),
(7, 'Циолковского, 17', '778877', 'Сазонов'),
(8, 'Павлова, 28', '321321', NULL),
(9, 'Новоселов, 36', '123123', 'Лоськов'),
(10, 'Забайкальская, 14', '445544', 'Родин');

INSERT INTO Товары (Код, Название, Группа_товаров, Фирма_производитель) VALUES
(1, 'Колбаса', 'Продукты', 'Скопинский'),
(2, 'Сыр', 'Продукты', 'Молоккомбинат'),
(3, 'Хлеб', 'Продукты', 'Хлебзавод 1'),
(4, 'Телевизор', 'Техника', 'Sony'),
(5, 'Стол', 'Мебель', 'IKEA'),
(6, 'Автокресло', NULL, NULL),
(7, 'Лопата', 'Хозтовары', 'Мехзавод'),
(8, 'Мочалка', 'Хозтовары', 'Авангард'),
(9, 'Мыло', 'Хозтовары', 'Свобода'),
(10, 'Кастрюля', 'Хозтовары', 'Технопласт');

INSERT INTO Наличие_товаров (Номер_склада, Код_товара, Количество) VALUES
(2,3,5000),
(1,10, 400),
(2,4,8000),
(2,7,1000),
(2,8, 7000),
(3,8, 9000),
(3,9, 15000),
(4,1,2500),
(4,8, 10000),
(5,2, 1000),
(6,5,800),
(7,7,700) ,
(7,2,9000),
(8,1,3000),
(9,5, 1000),
(9,8,5000),
(9,10, 500);


--2.1
-- Добавляем новые столбцы «Оптовая цена» и «Розничная цена»
ALTER TABLE Товары
ADD COLUMN Оптовая_цена DECIMAL(10, 2),
ADD COLUMN Розничная_цена DECIMAL(10, 2);

-- Добавляем ограничение на то, чтобы розничная цена не превышала оптовую более чем на 20%
ALTER TABLE Товары
ADD CONSTRAINT check_розничная_цена
CHECK (Розничная_цена <= Оптовая_цена * 1.2);

UPDATE Товары SET Оптовая_цена = 
  CASE
    WHEN Код = 1 THEN 100.00
    WHEN Код = 2 THEN 150.00
    WHEN Код = 3 THEN 50.00
    WHEN Код = 4 THEN 200.00
    WHEN Код = 5 THEN 80.00
    WHEN Код = 6 THEN 300.00
    WHEN Код = 7 THEN 30.00
    WHEN Код = 8 THEN 15.00
    WHEN Код = 9 THEN 10.00
    WHEN Код = 10 THEN 40.00
  END;

-- Устанавливаем розничную цену для хозтоваров (+10%)
UPDATE Товары
SET Розничная_цена = Оптовая_цена * 1.10
WHERE Группа_товаров = 'Хозтовары';

-- Устанавливаем розничную цену для продуктов (+5%)
UPDATE Товары
SET Розничная_цена = Оптовая_цена * 1.05
WHERE Группа_товаров = 'Продукты';

-- Устанавливаем розничную цену для техники (+15%)
UPDATE Товары
SET Розничная_цена = Оптовая_цена * 1.15
WHERE Группа_товаров = 'Техника';

-- Устанавливаем розничную цену для остальных товаров (+20%)
UPDATE Товары
SET Розничная_цена = Оптовая_цена * 1.20
WHERE Группа_товаров IS NULL OR Группа_товаров NOT IN ('Хозтовары', 'Продукты', 'Техника');


--2.2
-- Добавляем столбец «Площадь склада» с значением по умолчанию 15
ALTER TABLE Склады
ADD COLUMN Площадь_склада DECIMAL(5, 2) DEFAULT 15;

-- Добавляем ограничение на минимальное значение площади склада (не меньше 15 кв.м)
ALTER TABLE Склады
ADD CONSTRAINT check_площадь_склада
CHECK (Площадь_склада >= 15);


--2.3
-- Добавляем столбец «Скидка» в таблицу Товары
ALTER TABLE Товары
ADD COLUMN Скидка DECIMAL(5, 2);

-- Устанавливаем скидку 5%, если процент надбавки меньше 10%
UPDATE Товары
SET Скидка = 5
WHERE ((Розничная_цена - Оптовая_цена) / Оптовая_цена) * 100 < 10;

-- Устанавливаем скидку 10%, если процент надбавки от 10% до 15% включительно
UPDATE Товары
SET Скидка = 10
WHERE ((Розничная_цена - Оптовая_цена) / Оптовая_цена) * 100 >= 10
  AND ((Розничная_цена - Оптовая_цена) / Оптовая_цена) * 100 <= 15;

-- Устанавливаем скидку 15%, если процент надбавки больше 15%
UPDATE Товары
SET Скидка = 15
WHERE ((Розничная_цена - Оптовая_цена) / Оптовая_цена) * 100 > 15;


--2.4
-- 1. Удаляем внешний ключ из таблицы "Наличие_товаров"
ALTER TABLE Наличие_товаров
DROP CONSTRAINT Наличие_товаров_Номер_склада_fkey;

-- 2. Удаляем старый первичный ключ из таблицы "Склады"
ALTER TABLE Склады
DROP CONSTRAINT Склады_pkey;

-- 3. Добавляем новый столбец "Номер_склада" и задаем его как новый первичный ключ
ALTER TABLE Склады
ADD COLUMN Номер_склада SERIAL;

ALTER TABLE Склады
ADD CONSTRAINT pk_номер_склада PRIMARY KEY (Номер_склада);

-- 4. Восстанавливаем внешний ключ в таблице "Наличие_товаров", ссылаясь на новый первичный ключ
ALTER TABLE Наличие_товаров
ADD CONSTRAINT Наличие_товаров_Номер_склада_fkey
FOREIGN KEY (Номер_склада) REFERENCES Склады (Номер_склада) ON DELETE CASCADE;

--2.5
-- Таблица для групп товаров
CREATE TABLE ГруппыТоваров (
    Код SERIAL PRIMARY KEY,
    Наименование VARCHAR(255) NOT NULL,
    Описание TEXT
);

-- Таблица для фирм-производителей
CREATE TABLE ФирмыПроизводители (
    Код SERIAL PRIMARY KEY,
    Наименование VARCHAR(255) NOT NULL,
    Описание TEXT
);


-- Удаляем старые столбцы
ALTER TABLE Товары
DROP COLUMN Группа_товаров,
DROP COLUMN Фирма_производитель;

-- Добавляем новые столбцы для идентификаторов
ALTER TABLE Товары
ADD COLUMN Группа_товаров INT,
ADD COLUMN Фирма_производитель INT;

-- Связываем столбец "Группа_товаров" с таблицей "ГруппыТоваров"
ALTER TABLE Товары
ADD CONSTRAINT fk_группа_товаров
FOREIGN KEY (Группа_товаров)
REFERENCES ГруппыТоваров(Код)
ON DELETE CASCADE
ON UPDATE CASCADE;

-- Связываем столбец "Фирма_производитель" с таблицей "ФирмыПроизводители"
ALTER TABLE Товары
ADD CONSTRAINT fk_фирма_производитель
FOREIGN KEY (Фирма_производитель)
REFERENCES ФирмыПроизводители(Код)
ON DELETE CASCADE
ON UPDATE CASCADE;

INSERT INTO ГруппыТоваров (Код, Наименование, Описание) VALUES
(1, 'Продукты', 'Продукты питания'),
(2, 'Техника', 'Бытовая техника'),
(3, 'Мебель', 'Мебель для дома и офиса'),
(4, 'Хозтовары', 'Товары для хозяйства');

INSERT INTO ФирмыПроизводители (Код, Наименование, Описание) VALUES
(1, 'Скопинский', 'Производитель мясных продуктов'),
(2, 'Молоккомбинат', 'Производитель молочной продукции'),
(3, 'Хлебзавод 1', 'Производитель хлебобулочных изделий'),
(4, 'Sony', 'Электроника'),
(5, 'IKEA', 'Мебель'),
(6, 'Мехзавод', 'Производство инструментов'),
(7, 'Авангард', 'Производство бытовых товаров'),
(8, 'Свобода', 'Производство мыла и косметики'),
(9, 'Технопласт', 'Производство пластиковой посуды');


CREATE TEMPORARY TABLE обновления (
    Код INT, 
    Наименование VARCHAR(100), 
    Г INT, 
    П INT
);

INSERT INTO обновления VALUES
(1, 'Колбаса', 1, 1),  -- Продукты, Скопинский
(2, 'Сыр', 1, 2),      -- Продукты, Молоккомбинат
(3, 'Хлеб', 1, 3),     -- Продукты, Хлебзавод 1
(4, 'Телевизор', 2, 4), -- Техника, Sony
(5, 'Стол', 3, 5),     -- Мебель, IKEA
(6, 'Автокресло', NULL, NULL), -- Нет группы, нет производителя
(7, 'Лопата', 4, 6),   -- Хозтовары, Мехзавод
(8, 'Мочалка', 4, 7),  -- Хозтовары, Авангард
(9, 'Мыло', 4, 8),     -- Хозтовары, Свобода
(10, 'Кастрюля', 4, 9); -- Хозтовары, Технопласт


UPDATE Товары
SET Группа_товаров = обновления.Г,
    Фирма_производитель = обновления.П
FROM обновления
WHERE Товары.Код = обновления.Код;

ALTER TABLE ГруппыТоваров
DROP COLUMN Описание;

ALTER TABLE ФирмыПроизводители
DROP COLUMN Описание;

UPDATE ГруппыТоваров
SET Наименование = 'Основные продукты'
WHERE Наименование = 'Продукты';

UPDATE ФирмыПроизводители
SET Наименование = 'Samsung'
WHERE Наименование = 'Sony';

DELETE FROM ГруппыТоваров
WHERE Наименование = 'Мебель' OR Наименование = 'Хозтовары';

DELETE FROM ФирмыПроизводители
WHERE Наименование = 'Мехзавод' OR Наименование = 'Авангард';

ALTER TABLE Товары
DROP CONSTRAINT fk_фирма_производитель;

ALTER TABLE Товары
DROP CONSTRAINT fk_группа_товаров;

ALTER TABLE Товары
ALTER COLUMN Группа_товаров TYPE VARCHAR(100);

ALTER TABLE Товары
ALTER COLUMN Фирма_производитель TYPE VARCHAR(100);

UPDATE Товары
SET Группа_товаров = ГруппыТоваров.Наименование
FROM ГруппыТоваров
WHERE CAST(Товары.Группа_товаров AS INT) = ГруппыТоваров.Код;

UPDATE Товары
SET Фирма_производитель = ФирмыПроизводители.Наименование
FROM ФирмыПроизводители
WHERE CAST(Товары.Фирма_производитель AS INT) = ФирмыПроизводители.Код;

DROP TABLE IF EXISTS ГруппыТоваров CASCADE;
DROP TABLE IF EXISTS ФирмыПроизводители CASCADE;